---
name: swift-test
description: Write and run tests for Swift/iOS code including widgets, extensions, and native modules. Use when working on iOS native code.
disable-model-invocation: false
allowed-tools: Write, Edit, Bash, Read, Grep, Glob
---

# Swift/iOS Testing Workflow

Follow test-driven development for Swift code (widgets, extensions, native modules).

**CRITICAL**: User review is REQUIRED after writing failing tests, before proceeding to implementation.

## Test Framework: XCTest

All iOS tests use Apple's XCTest framework.

## Project Structure

**IMPORTANT**: The `ios/` folder is gitignored and regenerated by `expo prebuild`.

## Project Structure

Testable Swift code lives in a **Swift Package** that runs tests without Xcode:

```
packages/widget-utils/           # Swift Package (testable!)
├── Package.swift
├── Sources/WidgetUtils/
│   └── CountdownFormatter.swift  # Shared logic
└── Tests/WidgetUtilsTests/
    └── CountdownFormatterTests.swift

targets/jot-widget/              # Widget UI (@bacons/apple-targets)
├── JotWidget.swift
├── JotWidgetViews.swift
└── expo-target.config.js
```

## Running Tests

```bash
cd packages/widget-utils && swift test
```

No Xcode required! Tests run directly via Swift Package Manager.

## Phase 1: Red - Write Failing Tests

1. **Create test target** if it doesn't exist:
   - Open Xcode → File → New → Target → Unit Testing Bundle

2. **Create test file** in `ios/JotDev/JotDevTests/`:

   ```swift
   import XCTest
   @testable import JotWidgetExtension

   final class CountdownFormatterTests: XCTestCase {

       func testFormatDaysRemaining() {
           // Given
           let formatter = CountdownFormatter()
           let futureDate = Date().addingTimeInterval(86400 * 5) // 5 days

           // When
           let result = formatter.format(targetDate: futureDate)

           // Then
           XCTAssertEqual(result, "5 days")
       }

       func testFormatHoursWhenLessThanOneDay() {
           // ...
       }
   }
   ```

3. **Run tests** to confirm failure:
   ```bash
   cd packages/widget-utils && swift test
   ```

## ⏸️ CHECKPOINT: User Review Required

**STOP HERE and present to user:**

- Show the failing tests
- Explain what behavior each test covers
- Ask: "These tests cover [X, Y, Z]. Should I proceed with implementation?"
- Wait for explicit approval before continuing

## Phase 2: Green - Implement

1. Write minimal Swift code to pass tests
2. Run tests to confirm green:
   ```bash
   cd ios && xcodebuild test -workspace JotDev.xcworkspace -scheme JotDev -destination 'platform=macOS'
   ```

## Phase 3: Blue - Refactor

1. Improve code quality while tests pass
2. Follow Swift conventions:
   - Use `guard` for early returns
   - Prefer `let` over `var`
   - Use meaningful names
3. Run tests after each refactor

## Phase 4: Coverage - Fill in the Gaps

1. **Run coverage**:
   ```bash
   pnpm coverage:swift
   ```
2. **Review uncovered lines** in the llvm-cov output
3. **Add tests for missing branches** (error paths, edge cases)
4. **Target >80% line coverage** on new/modified files

## Test Patterns for Widgets

### Testing Timeline Providers

```swift
func testTimelineProviderReturnsCorrectEntries() {
    let provider = JotTimelineProvider()
    let expectation = XCTestExpectation(description: "Timeline loaded")

    provider.getTimeline(in: .never) { timeline in
        XCTAssertFalse(timeline.entries.isEmpty)
        XCTAssertEqual(timeline.policy, .atEnd)
        expectation.fulfill()
    }

    wait(for: [expectation], timeout: 5.0)
}
```

### Testing Data Store

```swift
func testWidgetDataStoreReadsCountdowns() {
    let store = WidgetDataStore()

    // Mock UserDefaults or App Group
    let mockDefaults = UserDefaults(suiteName: "test")!
    mockDefaults.set([...], forKey: "countdowns")

    let countdowns = store.loadCountdowns(from: mockDefaults)
    XCTAssertEqual(countdowns.count, 2)
}
```

## Running Tests

```bash
# Run all tests
cd ios && xcodebuild test -workspace JotDev.xcworkspace -scheme JotDev -destination 'platform=macOS'

# Run specific test class
cd ios && xcodebuild test -workspace JotDev.xcworkspace -scheme JotDev -destination 'platform=macOS' -only-testing:JotDevTests/CountdownFormatterTests

# Run with pretty output (install: brew install xcpretty)
cd ios && xcodebuild test ... | xcpretty
```

## Common Assertions

```swift
XCTAssertEqual(actual, expected)
XCTAssertTrue(condition)
XCTAssertFalse(condition)
XCTAssertNil(value)
XCTAssertNotNil(value)
XCTAssertThrowsError(try riskyOperation())
XCTAssertNoThrow(try safeOperation())
```

## Async Testing

```swift
func testAsyncOperation() async throws {
    let result = try await asyncFunction()
    XCTAssertEqual(result, expected)
}

// Or with expectations
func testCallbackOperation() {
    let expectation = expectation(description: "Callback called")

    performAsync { result in
        XCTAssertNotNil(result)
        expectation.fulfill()
    }

    waitForExpectations(timeout: 5.0)
}
```
