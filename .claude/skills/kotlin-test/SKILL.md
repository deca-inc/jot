---
name: kotlin-test
description: Write and run tests for Kotlin/Android code including widgets and native modules. Use when working on Android native code.
disable-model-invocation: false
allowed-tools: Write, Edit, Bash, Read, Grep, Glob
---

# Kotlin/Android Testing Workflow

Follow test-driven development for Kotlin code (widgets, native modules).

**CRITICAL**: User review is REQUIRED after writing failing tests, before proceeding to implementation.

## Test Frameworks

- **JUnit 4/5** - Unit tests (run on JVM, fast)
- **AndroidX Test** - Instrumented tests (run on device/emulator)
- **Robolectric** - Android unit tests without emulator

## Project Structure

**IMPORTANT**: The `android/` folder is gitignored and regenerated by `expo prebuild`.
Source files live in `native/android/` which is tracked in git:

```
native/android/
├── widget/                      # Widget source code (tracked)
│   ├── CountdownFormatter.kt
│   ├── JotWidgetProvider.kt
│   └── ...
└── widget-tests/                # Widget tests (tracked)
    └── CountdownFormatterTest.kt
```

During `expo prebuild`, files are copied automatically:

```
android/                         # GITIGNORED - regenerated
├── app/src/main/java/.../widget/     # Source copied from native/android/widget/
└── app/src/test/java/.../widget/     # Tests copied from native/android/widget-tests/
```

Tests run automatically with `./gradlew testDebugUnitTest`!

## Phase 1: Red - Write Failing Tests

1. **Create test file** in `android/app/src/test/java/com/dotdotdot/jot/dev/`:

   ```kotlin
   package com.dotdotdot.jot.dev.widget

   import org.junit.jupiter.api.Test
   import org.junit.jupiter.api.Assertions.*
   import java.util.Date

   class CountdownFormatterTest {

       @Test
       fun `format returns days when more than 24 hours`() {
           // Given
           val formatter = CountdownFormatter()
           val futureDate = Date(System.currentTimeMillis() + 86400000 * 5) // 5 days

           // When
           val result = formatter.format(futureDate)

           // Then
           assertEquals("5 days", result)
       }

       @Test
       fun `format returns hours when less than 24 hours`() {
           // ...
       }
   }
   ```

2. **Run tests** to confirm failure:
   ```bash
   pnpm test:kotlin
   ```

## ⏸️ CHECKPOINT: User Review Required

**STOP HERE and present to user:**

- Show the failing tests
- Explain what behavior each test covers
- Ask: "These tests cover [X, Y, Z]. Should I proceed with implementation?"
- Wait for explicit approval before continuing

## Phase 2: Green - Implement

1. Write minimal Kotlin code to pass tests
2. Run tests to confirm green:
   ```bash
   cd android && ./gradlew test
   ```

## Phase 3: Blue - Refactor

1. Improve code quality while tests pass
2. Follow Kotlin conventions:
   - Use data classes for DTOs
   - Prefer immutability (`val` over `var`)
   - Use scope functions appropriately (`let`, `apply`, `run`)
3. Run tests after each refactor

## Phase 4: Coverage - Fill in the Gaps

1. **Review test output** for any missed scenarios
2. **Add tests for missing branches** (error paths, edge cases, null handling)
3. **Target >80% coverage** on new/modified files
4. Note: Full JaCoCo coverage reports require additional Gradle setup

## Test Setup (build.gradle)

Ensure test dependencies are present in `android/app/build.gradle`:

```groovy
dependencies {
    // Unit testing
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.0'
    testImplementation 'org.mockito.kotlin:mockito-kotlin:5.1.0'
    testImplementation 'org.jetbrains.kotlinx:kotlinx-coroutines-test:1.7.3'

    // Instrumented testing
    androidTestImplementation 'androidx.test.ext:junit:1.1.5'
    androidTestImplementation 'androidx.test:runner:1.5.2'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
}

tasks.withType(Test) {
    useJUnitPlatform()
}
```

## Test Patterns for Widgets

### Testing Widget Data Store

```kotlin
class WidgetDataStoreTest {

    private lateinit var dataStore: WidgetDataStore
    private lateinit var mockContext: Context

    @BeforeEach
    fun setup() {
        mockContext = mock()
        val mockPrefs = mock<SharedPreferences>()
        whenever(mockContext.getSharedPreferences(any(), any())).thenReturn(mockPrefs)
        dataStore = WidgetDataStore(mockContext)
    }

    @Test
    fun `loadCountdowns returns empty list when no data`() {
        val result = dataStore.loadCountdowns()
        assertTrue(result.isEmpty())
    }
}
```

### Testing Widget Provider

```kotlin
class JotWidgetProviderTest {

    @Test
    fun `onUpdate triggers widget refresh`() {
        val provider = JotWidgetProvider()
        val mockContext = mock<Context>()
        val mockManager = mock<AppWidgetManager>()

        provider.onUpdate(mockContext, mockManager, intArrayOf(1, 2, 3))

        verify(mockManager, times(3)).updateAppWidget(any<Int>(), any())
    }
}
```

## Running Tests

```bash
# Run all unit tests
cd android && ./gradlew test

# Run specific test class
cd android && ./gradlew test --tests "com.dotdotdot.jot.dev.widget.CountdownFormatterTest"

# Run instrumented tests (requires emulator/device)
cd android && ./gradlew connectedAndroidTest

# Run with coverage
cd android && ./gradlew testDebugUnitTestCoverage
```

## Common Assertions

```kotlin
assertEquals(expected, actual)
assertTrue(condition)
assertFalse(condition)
assertNull(value)
assertNotNull(value)
assertThrows<IllegalArgumentException> { riskyOperation() }
assertDoesNotThrow { safeOperation() }
```

## Coroutine Testing

```kotlin
class AsyncServiceTest {

    @Test
    fun `fetchData returns correct result`() = runTest {
        val service = AsyncService()

        val result = service.fetchData()

        assertEquals(expected, result)
    }
}
```

## Mocking with Mockito-Kotlin

```kotlin
import org.mockito.kotlin.*

@Test
fun `test with mocks`() {
    val mockService = mock<MyService>()
    whenever(mockService.getData()).thenReturn("mocked")

    val result = mockService.getData()

    assertEquals("mocked", result)
    verify(mockService).getData()
}
```
